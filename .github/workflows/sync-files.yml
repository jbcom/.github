# File Sync Workflow - Creates PRs to sync files to all ecosystem repos
# Lives in jbcom/.github and syncs files from sync-files/ directory
#
# Triggers:
#   - Push to main when sync-files/** changes
#   - Manual dispatch for specific repos or all
#
# Behavior:
#   - Creates a PR (not direct push) for each repo
#   - Respects always-sync vs initial-only semantics
#   - Language-specific files based on repo prefix
#
# Required Secrets:
#   - REPO_SYNC_SSH_KEY: SSH private key for cloning/pushing to repos
#   - CI_GITHUB_TOKEN: PAT with repo scope for gh CLI operations (PR creation)

name: Sync Files to Repos

on:
  push:
    branches: [main]
    paths:
      - 'sync-files/**'
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repo (empty for all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (no PRs created)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

jobs:
  # Build list of repos to sync
  matrix:
    name: Build Repo Matrix
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.repos.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Build repo list
        id: repos
        run: |
          TARGET="${{ github.event.inputs.target_repo }}"
          
          if [[ -n "$TARGET" ]]; then
            # Single repo
            REPOS=$(jq -cn --arg repo "$TARGET" '[{name: $repo}]')
          else
            # All repos from repos.json
            REPOS=$(jq -c '[.repos[] | {name: .name, language: .language}]' repos.json)
          fi
          
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Will sync to $(echo "$REPOS" | jq length) repos"

  # Sync files to each repo via PR
  sync:
    name: Sync ${{ matrix.repo.name }}
    needs: matrix
    runs-on: ubuntu-latest
    if: needs.matrix.outputs.repos != '[]'
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        repo: ${{ fromJson(needs.matrix.outputs.repos) }}
    
    steps:
      - name: Validate required secrets
        run: |
          if [[ -z "${{ secrets.CI_GITHUB_TOKEN }}" ]]; then
            echo "::error::CI_GITHUB_TOKEN secret is required for cross-repository operations"
            exit 1
          fi
          if [[ -z "${{ secrets.REPO_SYNC_SSH_KEY }}" ]]; then
            echo "::error::REPO_SYNC_SSH_KEY secret is required for SSH authentication"
            exit 1
          fi

      - name: Checkout .github repo
        uses: actions/checkout@v4
        with:
          path: source
      
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.REPO_SYNC_SSH_KEY }}
      
      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      
      - name: Clone target repo
        run: |
          git clone "git@github.com:jbcom/${{ matrix.repo.name }}.git" target
          cd target
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine language
        id: lang
        run: |
          REPO="${{ matrix.repo.name }}"
          if [[ "$REPO" == python-* ]]; then
            echo "lang=python" >> $GITHUB_OUTPUT
          elif [[ "$REPO" == nodejs-* ]] || [[ "$REPO" == "jbcom.github.io" ]]; then
            echo "lang=nodejs" >> $GITHUB_OUTPUT
          elif [[ "$REPO" == go-* ]]; then
            echo "lang=go" >> $GITHUB_OUTPUT
          elif [[ "$REPO" == terraform-* ]]; then
            echo "lang=terraform" >> $GITHUB_OUTPUT
          else
            echo "lang=" >> $GITHUB_OUTPUT
          fi
      
      - name: Sync always-sync files
        run: |
          if [[ -d "source/sync-files/always-sync" ]]; then
            echo "Syncing always-sync files..."
            rsync -av --exclude='.git' \
              source/sync-files/always-sync/ \
              target/
          fi
      
      - name: Sync language-specific files
        run: |
          LANG="${{ steps.lang.outputs.lang }}"
          if [[ -n "$LANG" && -d "source/sync-files/$LANG" ]]; then
            echo "Syncing $LANG files..."
            rsync -av --exclude='.git' \
              "source/sync-files/$LANG/" \
              target/
          fi
      
      - name: Sync initial-only files (non-destructive)
        run: |
          if [[ -d "source/sync-files/initial-only" ]]; then
            echo "Syncing initial-only files (skip existing)..."
            cd source/sync-files/initial-only
            find . -type f | while read -r file; do
              dest="../../../target/$file"
              if [[ ! -f "$dest" ]]; then
                mkdir -p "$(dirname "$dest")"
                cp "$file" "$dest"
                echo "  Added: $file"
              fi
            done
          fi
      
      - name: Check for changes
        id: changes
        working-directory: target
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes for ${{ matrix.repo.name }}"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          fi
      
      - name: Create PR
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        working-directory: target
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          BRANCH="chore/sync-from-org-github"
          
          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            if ! git merge main --no-edit; then
              echo "Merge conflict - taking incoming changes"
              git checkout --theirs . || { echo "::error::Failed to resolve merge conflict"; exit 1; }
              git add -A
            fi
          else
            git checkout -b "$BRANCH"
          fi
          
          git add -A
          git commit -m "chore: sync files from jbcom/.github

          Automated sync of shared configurations.
          Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push -u origin "$BRANCH" --force-with-lease
          
          # Create or update PR
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [[ -n "$EXISTING_PR" ]]; then
            echo "Updated existing PR #$EXISTING_PR"
          else
            gh pr create \
              --title "chore: sync files from jbcom/.github" \
              --body "Automated sync of shared configurations from the organization .github repository.

          ## Files Synced
          - Cursor rules and AI agent configurations
          - GitHub workflow templates
          - Standard issue/PR templates

          ---
          _This PR was created automatically by the file sync workflow._" \
              --head "$BRANCH" \
              --base main
          fi
